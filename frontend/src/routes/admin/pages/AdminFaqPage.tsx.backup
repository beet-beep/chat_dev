import {
  Alert,
  Box,
  Button,
  Checkbox,
  Divider,
  FormControlLabel,
  InputAdornment,
  List,
  ListItemButton,
  ListItemText,
  MenuItem,
  Snackbar,
  TextField,
  Typography,
} from "@mui/material";
import SearchIcon from "@mui/icons-material/Search";
import SaveOutlinedIcon from "@mui/icons-material/SaveOutlined";
import DeleteOutlineIcon from "@mui/icons-material/DeleteOutline";
import ImageIcon from "@mui/icons-material/Image";
import VideoLibraryIcon from "@mui/icons-material/VideoLibrary";
import HorizontalRuleIcon from "@mui/icons-material/HorizontalRule";
import ExpandMoreIcon from "@mui/icons-material/ExpandMore";
import TableChartIcon from "@mui/icons-material/TableChart";
import { useEffect, useMemo, useRef, useState } from "react";
import { useSearchParams } from "react-router-dom";

import {
  adminCreateFaq,
  adminCreateFaqCategory,
  adminDeleteFaq,
  adminDeleteFaqCategory,
  adminListFaqCategories,
  adminListFaqs,
  adminPatchFaq,
  adminPatchFaqCategory,
  adminUploadFaqFiles,
} from "../../../api/support";

type AdminFaq = any;
type AdminCategory = any;

function looksLikeHtml(s: any) {
  const t = String(s || "").trim();
  if (!t) return false;
  return /<\/?[a-z][\s\S]*>/i.test(t);
}

function escapeHtml(s: string) {
  const t = String(s || "");
  // Avoid String.prototype.replaceAll for older TS lib targets.
  return t
    .split("&")
    .join("&amp;")
    .split("<")
    .join("&lt;")
    .split(">")
    .join("&gt;")
    .split('"')
    .join("&quot;")
    .split("'")
    .join("&#039;");
}

function blocksToHtml(blocks: any[]): string {
  const b = Array.isArray(blocks) ? blocks : [];
  const out: string[] = [];
  for (const it of b) {
    const type = String(it?.type || "");
    if (type === "paragraph") out.push(`<p>${escapeHtml(String(it?.text || ""))}</p>`);
    else if (type === "heading") out.push(`<h3>${escapeHtml(String(it?.text || ""))}</h3>`);
    else if (type === "callout") out.push(`<blockquote>${escapeHtml(String(it?.text || ""))}</blockquote>`);
    else if (type === "bullets") {
      const items = Array.isArray(it?.items) ? it.items : [];
      out.push(`<ul>${items.map((x: any) => `<li>${escapeHtml(String(x || ""))}</li>`).join("")}</ul>`);
    } else if (type === "numbered") {
      const items = Array.isArray(it?.items) ? it.items : [];
      out.push(`<ol>${items.map((x: any) => `<li>${escapeHtml(String(x || ""))}</li>`).join("")}</ol>`);
    } else if (type === "divider") out.push("<hr/>");
    else if (type === "image") out.push(`<p><img src="${escapeHtml(String(it?.url || ""))}" /></p>`);
    else if (type === "video") out.push(`<p><video controls src="${escapeHtml(String(it?.url || ""))}"></video></p>`);
    else if (type === "file") {
      const url = String(it?.url || "");
      const name = String(it?.name || url);
      out.push(`<p><a href="${escapeHtml(url)}" target="_blank" rel="noreferrer">${escapeHtml(name)}</a></p>`);
    }
  }
  const html = out.join("");
  return html || "<p></p>";
}

export function AdminFaqPage() {
  const [searchParams, setSearchParams] = useSearchParams();
  const [categories, setCategories] = useState<AdminCategory[] | null>(null);
  const [faqs, setFaqs] = useState<AdminFaq[] | null>(null);
  const [activeId, setActiveId] = useState<number | null>(null);
  const [q, setQ] = useState("");
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [toast, setToast] = useState<{ open: boolean; message: string; severity: "success" | "error" | "info" }>({
    open: false,
    message: "",
    severity: "info",
  });

  // right sidebar state
  const [newCatName, setNewCatName] = useState("");
  const [newCatUrl, setNewCatUrl] = useState("");
  const [newCatIsGuide, setNewCatIsGuide] = useState(false);
  const [newCatOrder, setNewCatOrder] = useState<number>(0);

  // Draft state (decoupled from faqs list) to prevent editor instability/unmounts while typing.
  const [draftTitle, setDraftTitle] = useState("");
  const [draftBody, setDraftBody] = useState("");
  const [draftCategoryId, setDraftCategoryId] = useState<number | "">("");
  const [draftPopular, setDraftPopular] = useState(false);
  const [draftHidden, setDraftHidden] = useState(false);
  const draftInitForId = useRef<number | null>(null);
  const [viewMode, setViewMode] = useState<"html" | "preview">("html");

  const guideCats = useMemo(() => {
    const list = categories ?? [];
    return [...list]
      .filter((c: any) => Boolean(c.is_guide_link) || c.kind === "GUIDE")
      .sort((a: any, b: any) => (Number(a.order ?? 0) - Number(b.order ?? 0)) || (a.id - b.id));
  }, [categories]);

  const mainCats = useMemo(() => {
    const list = categories ?? [];
    return [...list]
      .filter((c: any) => !(Boolean(c.is_guide_link) || c.kind === "GUIDE"))
      .sort((a: any, b: any) => (Number(a.order ?? 0) - Number(b.order ?? 0)) || (a.id - b.id));
  }, [categories]);

  async function refresh() {
    setError(null);
    try {
      const [cats, docs] = await Promise.all([adminListFaqCategories(), adminListFaqs()]);
      setCategories(cats);
      setFaqs(docs);
      
      // ìƒˆë¡œê³ ì¹¨ ì‹œ URL íŒŒë¼ë¯¸í„°ì—ì„œ FAQ ID ë³µì›
      const faqIdFromUrl = searchParams.get("faq");
      const faqIdNum = faqIdFromUrl ? Number(faqIdFromUrl) : null;
      
      if (faqIdNum && docs.some((d: any) => d.id === faqIdNum)) {
        // URLì— ì§€ì •ëœ FAQê°€ ì¡´ì¬í•˜ë©´ ê·¸ê²ƒì„ í™œì„±í™”
        setActiveId(faqIdNum);
      } else {
        // URLì— FAQê°€ ì—†ê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì²« ë²ˆì§¸ FAQ ì„ íƒ
        setActiveId((prev) => {
          if (prev && docs.some((d: any) => d.id === prev)) return prev;
          const firstId = docs.length ? docs[0].id : null;
          if (firstId) {
            setSearchParams({ faq: String(firstId) }, { replace: true });
          }
          return firstId;
        });
      }
    } catch (e: any) {
      setCategories([]);
      setFaqs([]);
      setError(String(e?.payload?.detail || e?.message || e));
    }
  }

  useEffect(() => {
    refresh().catch(() => {});
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const filtered = useMemo(() => {
    const s = q.trim().toLowerCase();
    if (!faqs) return null;
    if (!Array.isArray(faqs)) return [];
    if (!s) return faqs;
    return faqs.filter((f: any) => `${f.title} ${f.body}`.toLowerCase().includes(s));
  }, [faqs, q]);

  // IMPORTANT: Active doc must be derived from the full list, not the filtered list.
  // Otherwise typing/editing can remove the doc from `filtered` and the editor "disappears".
  const active = useMemo(() => (Array.isArray(faqs) ? faqs.find((f: any) => f.id === activeId) : null) ?? null, [faqs, activeId]);

  // Initialize editor draft when switching active doc (do NOT mutate list objects).
  useEffect(() => {
    if (!active) return;
    if (draftInitForId.current === active.id) return;
    draftInitForId.current = active.id;

    const body =
      looksLikeHtml(active.body)
        ? String(active.body || "")
        : Array.isArray(active.blocks) && active.blocks.length
        ? blocksToHtml(active.blocks)
        : String(active.body || "");

    setDraftTitle(String(active.title || ""));
    setDraftBody(body || "<p></p>");
    setDraftCategoryId(active.category?.id ?? "");
    setDraftPopular(Boolean(active.is_popular));
    setDraftHidden(Boolean(active.is_hidden));
  }, [activeId, active?.id]); // eslint-disable-line react-hooks/exhaustive-deps

  // Ensure the selected category always exists in the dropdown options.
  useEffect(() => {
    if (!draftCategoryId) return;
    if (!mainCats.length) return;
    if (mainCats.some((c) => c.id === Number(draftCategoryId))) return;
    setDraftCategoryId("");
  }, [draftCategoryId, mainCats]);

  // Initialize Quill editor once on mount
  useEffect(() => {
    if (!quillContainerRef.current || quillRef.current) return;
    
    try {
      const quill = new Quill(quillContainerRef.current, {
        theme: "snow",
        placeholder: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...",
        modules: {
          "better-table": {
            operationMenu: {
              items: {
                unmergeCells: {
                  text: "ì…€ ë³‘í•© í•´ì œ",
                },
              },
            },
          },
          keyboard: {
            bindings: QuillBetterTable.keyboardBindings,
          },
          toolbar: [
            [{ header: [1, 2, 3, false] }],
            ["bold", "italic", "underline", "strike"],
            [{ color: [] }, { background: [] }],
            [{ list: "ordered" }, { list: "bullet" }],
            [{ indent: "-1" }, { indent: "+1" }],
            [{ align: [] }],
            ["blockquote", "code-block"],
            ["link", "image", "video"],
            ["clean"],
          ],
        },
      });

      // Add table module to Quill instance
      const tableModule = quill.getModule("better-table");
      if (tableModule) {
        console.log("âœ… Table module loaded");
      }

      // Listen to changes
      quill.on("text-change", () => {
        setDraftBody(quill.root.innerHTML);
      });

      quillRef.current = quill;
      setIsQuillReady(true);
      console.log("âœ… Quill initialized successfully");
    } catch (error) {
      console.error("âŒ Quill initialization failed:", error);
      setIsQuillReady(false);
    }
  }, []);

  // Update Quill content when switching documents
  useEffect(() => {
    if (!quillRef.current || !isQuillReady) return;
    if (!activeId) return;
    
    // Only update if the draft was initialized for a different document
    const shouldUpdate = draftInitForId.current === activeId;
    if (!shouldUpdate) return;
    
    try {
      const quill = quillRef.current;
      const currentHtml = quill.root.innerHTML;
      const newHtml = draftBody || "<p><br></p>";
      
      // Only update if content actually changed
      if (currentHtml !== newHtml) {
        quill.root.innerHTML = newHtml;
        console.log("ğŸ“ Quill content updated for FAQ", activeId);
      }
    } catch (error) {
      console.error("âŒ Quill content update failed:", error);
    }
  }, [activeId, draftBody, isQuillReady]);

  async function onCreateCategory() {
    if (!newCatName.trim()) return;
    setBusy(true);
    try {
      await adminCreateFaqCategory({
        name: newCatName.trim(),
        guide_url: newCatIsGuide ? newCatUrl.trim() || "" : "",
        kind: newCatIsGuide ? "GUIDE" : "GENERAL",
        is_guide_link: newCatIsGuide,
        order: Number(newCatOrder ?? 0),
      } as any);
      setNewCatName("");
      setNewCatUrl("");
      setNewCatIsGuide(false);
      setNewCatOrder(0);
      await refresh();
    } finally {
      setBusy(false);
    }
  }

  async function onSaveCategory(cat: any) {
    setBusy(true);
    try {
      await adminPatchFaqCategory(cat.id, {
        guide_url: cat.is_guide_link ? cat.guide_url || "" : "",
        name: cat.name,
        order: cat.order,
        kind: cat.is_guide_link ? "GUIDE" : (cat.kind || "GENERAL"),
        is_guide_link: Boolean(cat.is_guide_link),
      } as any);
      await refresh();
    } finally {
      setBusy(false);
    }
  }

  async function onCreateFaq() {
    setBusy(true);
    setError(null);
    try {
      const doc = await adminCreateFaq({
        category_id: categories?.[0]?.id ?? null,
        title: "ìƒˆ FAQ",
        body: "",
        blocks: [{ type: "paragraph", text: "" }],
        is_popular: false,
        is_hidden: false,
        order: 0,
      });
      await refresh();
      setActiveId(doc.id);
      setSearchParams({ faq: String(doc.id) }, { replace: true });
      setToast({ open: true, severity: "success", message: "ìƒˆ FAQë¥¼ ìƒì„±í–ˆì–´ìš”." });
    } catch (e: any) {
      const msg = String(e?.payload?.detail || e?.message || e);
      setError(msg);
      setToast({ open: true, severity: "error", message: `FAQ ìƒì„± ì‹¤íŒ¨: ${msg}` });
    } finally {
      setBusy(false);
    }
  }

  async function onSaveFaq() {
    if (!active) return;
    const bodyToSave = String(draftBody || "");

    setBusy(true);
    setError(null);
    try {
      await adminPatchFaq(active.id, {
        category_id: draftCategoryId === "" ? null : Number(draftCategoryId),
        title: String(draftTitle || "").trim() || "ì œëª© ì—†ìŒ",
        body: bodyToSave,
        blocks: [],
        is_popular: Boolean(draftPopular),
        is_hidden: Boolean(draftHidden),
        order: Number(active.order ?? 0),
      });
      // Update local list without forcing a full refresh (prevents editor flicker).
      setFaqs((prev) => {
        if (!Array.isArray(prev)) return prev;
        return prev.map((f: any) =>
          f.id !== active.id
            ? f
            : {
                ...f,
                title: String(draftTitle || "").trim() || "ì œëª© ì—†ìŒ",
                body: bodyToSave,
                is_popular: Boolean(draftPopular),
                is_hidden: Boolean(draftHidden),
                category:
                  draftCategoryId === ""
                    ? null
                    : (categories ?? []).find((c: any) => c.id === Number(draftCategoryId)) ?? f.category,
              }
        );
      });
      setToast({ open: true, severity: "success", message: "FAQ ì €ì¥ ì™„ë£Œ" });
    } catch (e: any) {
      const msg = String(e?.payload?.detail || e?.message || e);
      setError(msg);
      setToast({ open: true, severity: "error", message: `ì €ì¥ ì‹¤íŒ¨: ${msg}` });
    } finally {
      setBusy(false);
    }
  }

  async function onDeleteActiveFaq() {
    if (!active?.id) return;
    const ok = window.confirm("ì´ FAQë¥¼ ì‚­ì œí• ê¹Œìš”? (ë³µêµ¬ ë¶ˆê°€)");
    if (!ok) return;
    setBusy(true);
    setError(null);
    try {
      await adminDeleteFaq(active.id);
      // remove locally
      const next = (faqs ?? []).filter((f: any) => f.id !== active.id);
      setFaqs(next);
      setActiveId(next[0]?.id ?? null);
      await refresh();
      setToast({ open: true, severity: "success", message: "FAQë¥¼ ì‚­ì œí–ˆì–´ìš”." });
    } catch (e: any) {
      const msg = String(e?.payload?.detail || e?.message || e);
      setError(msg);
      setToast({ open: true, severity: "error", message: `ì‚­ì œ ì‹¤íŒ¨: ${msg}` });
    } finally {
      setBusy(false);
    }
  }

  async function onDeleteCategory(cat: any) {
    if (!cat?.id) return;
    const ok = window.confirm(`'${cat.name}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí• ê¹Œìš”? ì´ ì¹´í…Œê³ ë¦¬ì— ì†í•œ ë¬¸ì„œë“¤ì˜ ì¹´í…Œê³ ë¦¬ê°€ í•´ì œë©ë‹ˆë‹¤.`);
    if (!ok) return;
    setBusy(true);
    try {
      await adminDeleteFaqCategory(cat.id);
      await refresh();
    } catch (e: any) {
      setError(String(e?.payload?.detail || e?.message || e));
    } finally {
      setBusy(false);
    }
  }

  async function onUploadMedia(files: File[]) {
    if (!active || !files.length) return;
    setBusy(true);
    setError(null);
    try {
      const res = await adminUploadFaqFiles(active.id, files);
      const attachments = res.attachments ?? [];
      
      if (quillRef.current) {
        // WYSIWYG ëª¨ë“œ: Quillì— ì§ì ‘ ì‚½ì…
        const quill = quillRef.current;
        const range = quill.getSelection(true) || { index: quill.getLength(), length: 0 };
        let cursor = range.index;
        
        for (const a of attachments) {
          const ct = String(a.content_type || "");
          if (ct.startsWith("image/")) {
            quill.insertEmbed(cursor, "image", a.url);
            cursor += 1;
          } else if (ct.startsWith("video/")) {
            quill.insertEmbed(cursor, "video", a.url);
            cursor += 1;
          }
          quill.insertText(cursor, "\n");
          cursor += 1;
        }
        quill.setSelection(cursor, 0);
      } else {
        // HTML/ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œ: HTMLë¡œ ì‚½ì…
        let insertHtml = "";
        for (const a of attachments) {
          const ct = String(a.content_type || "");
          if (ct.startsWith("image/")) {
            insertHtml += `<p><img src="${a.url}" alt="${a.original_name || ''}" style="max-width: 100%;" /></p>\n`;
          } else if (ct.startsWith("video/")) {
            insertHtml += `<p><video controls src="${a.url}" style="max-width: 100%;"></video></p>\n`;
          } else {
            insertHtml += `<p><a href="${a.url}" target="_blank" rel="noreferrer">${a.original_name || a.url}</a></p>\n`;
          }
        }
        setDraftBody((prev) => prev + "\n" + insertHtml);
      }
      
      setToast({ open: true, severity: "success", message: "ë¯¸ë””ì–´ë¥¼ ì‚½ì…í–ˆì–´ìš”. ì €ì¥ì„ ëˆŒëŸ¬ ë°˜ì˜í•˜ì„¸ìš”." });
    } catch (e: any) {
      const msg = String(e?.payload?.detail || e?.message || e);
      setError(msg);
      setToast({ open: true, severity: "error", message: `ì—…ë¡œë“œ ì‹¤íŒ¨: ${msg}` });
    } finally {
      setBusy(false);
    }
  }

  function insertDivider() {
    setDraftBody((prev) => prev + "\n<hr />\n");
    setToast({ open: true, severity: "info", message: "êµ¬ë¶„ì„ ì„ ì‚½ì…í–ˆì–´ìš”." });
  }

  function insertToggle() {
    const title = window.prompt("í† ê¸€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if (!title) return;
    const content = window.prompt("í† ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if (!content) return;
    const toggleHtml = `
<details style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin: 8px 0;">
  <summary style="cursor: pointer; font-weight: 700; list-style: none; display: flex; align-items: center;">
    <span style="margin-right: 8px;">â–¶</span> ${title}
  </summary>
  <div style="margin-top: 12px; padding-left: 24px;">
    ${content}
  </div>
</details>
`;
    setDraftBody((prev) => prev + "\n" + toggleHtml);
    setToast({ open: true, severity: "info", message: "í† ê¸€ì„ ì‚½ì…í–ˆì–´ìš”." });
  }

  return (
    <>
    <Box sx={{ height: "100%", display: "grid", gridTemplateColumns: "320px 1fr 380px", overflow: "hidden" }}>
      {/* left: document list */}
      <Box sx={{ bgcolor: "background.paper", borderRight: "1px solid", borderColor: "divider", display: "flex", flexDirection: "column" }}>
        <Box sx={{ p: 2 }}>
          <Typography sx={{ fontWeight: 900, mb: 1.5 }}>FAQ CMS</Typography>
          <TextField
            fullWidth
            size="small"
            placeholder="ë¬¸ì„œ ê²€ìƒ‰"
            value={q}
            onChange={(e) => setQ(e.target.value)}
            InputProps={{
              startAdornment: (
                <InputAdornment position="start">
                  <SearchIcon sx={{ color: "text.secondary", fontSize: 20 }} />
                </InputAdornment>
              ),
              sx: { borderRadius: 1.5, bgcolor: "rgba(15,23,42,0.02)" }
            }}
          />
          <Button
            variant="contained"
            fullWidth
            sx={{ mt: 1.5, fontWeight: 900, borderRadius: 1.5 }}
            onClick={onCreateFaq}
          >
            + ìƒˆ FAQ ì‘ì„±
          </Button>
        </Box>
        <Divider />
        <List dense sx={{ overflow: "auto", flex: 1 }}>
          {!filtered ? (
            <Box sx={{ p: 2, color: "text.secondary" }}>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</Box>
          ) : filtered.length === 0 ? (
            <Box sx={{ p: 2, color: "text.secondary" }}>ë¬¸ì„œê°€ ì—†ì–´ìš”.</Box>
          ) : (
            filtered.map((f: any) => (
              <Box key={f.id} sx={{ borderBottom: "1px solid", borderColor: "divider" }}>
                <ListItemButton
                  selected={f.id === activeId}
                  onClick={() => {
                    setActiveId(f.id);
                    setSearchParams({ faq: String(f.id) }, { replace: true });
                  }}
                  sx={{
                    py: 1.5,
                    "&.Mui-selected": { bgcolor: "rgba(37,99,235,0.08)" },
                    "&:hover": { bgcolor: "rgba(37,99,235,0.04)" }
                  }}
                >
                  <ListItemText
                    primary={
                      <Typography sx={{ color: "text.primary", fontWeight: 900, fontSize: "0.95rem" }} noWrap>
                        {f.title}
                      </Typography>
                    }
                    secondary={
                      <Typography sx={{ color: "text.secondary", fontSize: "0.8rem", mt: 0.25 }} noWrap>
                        {(f.is_hidden ? "ìˆ¨ê¹€ Â· " : "") + (f.category?.name ?? "ë¯¸ì§€ì •")}
                      </Typography>
                    }
                  />
                </ListItemButton>
              </Box>
            ))
          )}
        </List>
      </Box>

      {/* center: editor area */}
      <Box sx={{ bgcolor: "background.default", p: 3, overflow: "auto", display: "flex", justifyContent: "center" }}>
        <Box sx={{ width: "100%", maxWidth: 880 }}>
          {error ? (
            <Box sx={{ mb: 3, border: "1px solid", borderColor: "#FECACA", bgcolor: "#FEF2F2", p: 2, borderRadius: 2 }}>
              <Typography sx={{ fontWeight: 900, color: "#DC2626" }}>ì˜¤ë¥˜ ë°œìƒ: {error}</Typography>
            </Box>
          ) : null}

          {!active ? (
            <Box sx={{ height: "100%", display: "grid", placeItems: "center", opacity: 0.5 }}>
              <Typography sx={{ fontWeight: 900 }}>ì¢Œì¸¡ì—ì„œ ê´€ë¦¬í•  ë¬¸ì„œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</Typography>
            </Box>
          ) : (
            <Box key={active.id} sx={{ display: "grid", gap: 2.5 }}>
              <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                <Typography variant="h6" sx={{ fontWeight: 900 }}>FAQ ë¬¸ì„œ í¸ì§‘</Typography>
                <Button variant="outlined" color="error" disabled={busy} onClick={onDeleteActiveFaq} sx={{ fontWeight: 900 }}>
                  ì‚­ì œ
                </Button>
              </Box>

              <TextField
                label="ì œëª©"
                fullWidth
                value={draftTitle}
                onChange={(e) => setDraftTitle(e.target.value)}
                InputProps={{ sx: { bgcolor: "#fff", fontWeight: 900, fontSize: "1.1rem" } }}
              />

              <Box sx={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 2 }}>
                <TextField
                  select
                  label="ì¹´í…Œê³ ë¦¬"
                  value={draftCategoryId}
                  onChange={(e) => {
                    const v = e.target.value === "" ? "" : Number(e.target.value);
                    setDraftCategoryId(v as any);
                  }}
                  InputProps={{ sx: { bgcolor: "#fff" } }}
                >
                  {(categories ?? []).filter((c: any) => !(Boolean(c.is_guide_link) || c.kind === "GUIDE")).map((c: any) => (
                    <MenuItem key={c.id} value={c.id}>
                      {c.name}
                    </MenuItem>
                  ))}
                </TextField>

                <Box sx={{ display: "flex", gap: 2, alignItems: "center" }}>
                  <FormControlLabel
                    control={
                      <Checkbox
                        checked={Boolean(draftPopular)}
                        onChange={(e) => setDraftPopular(e.target.checked)}
                      />
                    }
                    label={<Typography sx={{ fontWeight: 900 }}>ì¸ê¸° ë¬¸ì„œ</Typography>}
                  />
                  <FormControlLabel
                    control={
                      <Checkbox
                        checked={Boolean(draftHidden)}
                        onChange={(e) => setDraftHidden(e.target.checked)}
                      />
                    }
                    label={<Typography sx={{ fontWeight: 900 }}>ìˆ¨ê¹€ ì²˜ë¦¬</Typography>}
                  />
                </Box>
              </Box>

              <Box sx={{ display: "grid", gap: 1 }}>
                <Box sx={{ display: "flex", alignItems: "center", justifyContent: "space-between", mb: 1 }}>
                  <Typography sx={{ fontWeight: 900, fontSize: "0.95rem" }}>ë³¸ë¬¸</Typography>
                  <Box sx={{ display: "flex", gap: 0.5 }}>
                    <Button
                      size="small"
                      variant={editorMode === "wysiwyg" ? "contained" : "outlined"}
                      onClick={() => setEditorMode("wysiwyg")}
                      sx={{ fontWeight: 900, minWidth: 70 }}
                    >
                      ë³¸ë¬¸
                    </Button>
                    <Button
                      size="small"
                      variant={editorMode === "html" ? "contained" : "outlined"}
                      onClick={() => {
                        // Quillì˜ í˜„ì¬ ë‚´ìš©ì„ ê°€ì ¸ì™€ì„œ ë™ê¸°í™”
                        if (quillRef.current) {
                          setDraftBody(quillRef.current.root.innerHTML);
                        }
                        setEditorMode("html");
                      }}
                      sx={{ fontWeight: 900, minWidth: 70 }}
                    >
                      HTML
                    </Button>
                    <Button
                      size="small"
                      variant={editorMode === "preview" ? "contained" : "outlined"}
                      onClick={() => {
                        // Quillì˜ í˜„ì¬ ë‚´ìš©ì„ ê°€ì ¸ì™€ì„œ ë™ê¸°í™”
                        if (quillRef.current) {
                          setDraftBody(quillRef.current.root.innerHTML);
                        }
                        setEditorMode("preview");
                      }}
                      sx={{ fontWeight: 900, minWidth: 80 }}
                    >
                      ë¯¸ë¦¬ë³´ê¸°
                    </Button>
                  </Box>
                </Box>

                {/* Quill Editor - í•­ìƒ ë³´ì´ë„ë¡ í•˜ë˜ ë‹¤ë¥¸ ëª¨ë“œì¼ ë•ŒëŠ” visibilityë¡œ ìˆ¨ê¹€ */}
                <Box
                  sx={{
                    visibility: editorMode === "wysiwyg" ? "visible" : "hidden",
                    height: editorMode === "wysiwyg" ? "auto" : 0,
                    overflow: editorMode === "wysiwyg" ? "visible" : "hidden",
                    border: "1px solid",
                    borderColor: "divider",
                    borderRadius: 2,
                    bgcolor: "#fff",
                    "& .ql-toolbar": {
                      borderBottom: "1px solid #e5e7eb",
                      bgcolor: "#fafafa",
                    },
                    "& .ql-container": {
                      minHeight: 500,
                      fontSize: "1rem",
                      fontFamily: "inherit",
                    },
                    "& .ql-editor": {
                      minHeight: 500,
                      "& p": { marginBottom: "0.75em" },
                      "& img": { maxWidth: "100%", cursor: "pointer" },
                      "& table": {
                        borderCollapse: "collapse",
                        width: "100%",
                        margin: "1em 0",
                        border: "1px solid #d1d5db",
                        "& td, & th": {
                          border: "1px solid #d1d5db",
                          padding: "10px 12px",
                          minWidth: "80px",
                          verticalAlign: "top",
                        },
                        "& th": {
                          bgcolor: "#f3f4f6",
                          fontWeight: 700,
                        },
                      },
                      // better-table specific styles
                      "& .quill-better-table": {
                        "& table": {
                          border: "1px solid #d1d5db",
                        },
                        "& td, & th": {
                          border: "1px solid #d1d5db !important",
                          padding: "10px 12px !important",
                        },
                      },
                    },
                  }}
                >
                  <div ref={quillContainerRef} />
                </Box>

                {editorMode === "html" ? (
                  <TextField
                    label="HTML ì½”ë“œ"
                    multiline
                    fullWidth
                    rows={22}
                    value={draftBody}
                    onChange={(e) => {
                      setDraftBody(e.target.value);
                      // HTML ëª¨ë“œì—ì„œ ë³€ê²½í•˜ë©´ Quillë„ ë™ê¸°í™”
                      if (quillRef.current) {
                        quillRef.current.root.innerHTML = e.target.value;
                      }
                    }}
                    InputProps={{
                      sx: {
                        bgcolor: "#fff",
                        fontFamily: "monospace",
                        fontSize: "0.9rem",
                        lineHeight: 1.6,
                      },
                    }}
                    helperText="HTML ì½”ë“œë¥¼ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
                  />
                ) : null}

                {editorMode === "preview" ? (
                  <Box
                    sx={{
                      border: "1px solid",
                      borderColor: "divider",
                      borderRadius: 2,
                      bgcolor: "#fff",
                      p: 3,
                      minHeight: 500,
                      maxHeight: 600,
                      overflow: "auto",
                      "& img": { maxWidth: "100%", height: "auto", borderRadius: 1 },
                      "& video": { maxWidth: "100%", height: "auto", borderRadius: 1 },
                      "& p": { margin: "0.75em 0" },
                      "& h1, & h2, & h3": { marginTop: "1em", marginBottom: "0.5em", fontWeight: 900 },
                      "& ul, & ol": { paddingLeft: "1.5em", margin: "0.75em 0" },
                      "& hr": { margin: "1.5em 0", border: "none", borderTop: "1px solid #e5e7eb" },
                      "& a": { color: "#2563eb", textDecoration: "underline" },
                      "& blockquote": { borderLeft: "4px solid #e5e7eb", paddingLeft: "1em", margin: "1em 0", color: "#64748b" },
                      "& table": {
                        borderCollapse: "collapse",
                        width: "100%",
                        margin: "1em 0",
                        border: "1px solid #d1d5db",
                        "& td, & th": {
                          border: "1px solid #d1d5db",
                          padding: "10px 12px",
                          verticalAlign: "top",
                        },
                        "& th": {
                          bgcolor: "#f3f4f6",
                          fontWeight: 700,
                        },
                      },
                    }}
                    dangerouslySetInnerHTML={{ __html: draftBody || "<p style='color: #94a3b8;'>ë³¸ë¬¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>" }}
                  />
                ) : null}
                
                <Box sx={{ display: "flex", gap: 1, flexWrap: "wrap" }}>
                  <Button
                    variant="outlined"
                    size="small"
                    startIcon={<TableChartIcon />}
                    sx={{ fontWeight: 900 }}
                    onClick={() => {
                      const cols = window.prompt("ì—´ ê°œìˆ˜:", "3");
                      const rows = window.prompt("í–‰ ê°œìˆ˜:", "3");
                      if (!cols || !rows) return;
                      const c = parseInt(cols);
                      const r = parseInt(rows);
                      if (isNaN(c) || isNaN(r) || c < 1 || r < 1) return;
                      
                      if (quillRef.current) {
                        const tableModule = quillRef.current.getModule("better-table") as any;
                        if (tableModule && typeof tableModule.insertTable === "function") {
                          // Use better-table API
                          tableModule.insertTable(r, c);
                          console.log(`âœ… Inserted ${r}x${c} table`);
                        } else {
                          // Fallback to HTML insertion
                          let tableHtml = '<table style="border-collapse: collapse; width: 100%; margin: 1em 0;"><tbody>';
                          for (let i = 0; i < r; i++) {
                            tableHtml += "<tr>";
                            for (let j = 0; j < c; j++) {
                              tableHtml += '<td style="border: 1px solid #e5e7eb; padding: 8px;"><br></td>';
                            }
                            tableHtml += "</tr>";
                          }
                          tableHtml += "</tbody></table><p><br></p>";
                          const range = quillRef.current.getSelection(true) || { index: quillRef.current.getLength(), length: 0 };
                          quillRef.current.clipboard.dangerouslyPasteHTML(range.index, tableHtml);
                        }
                      } else {
                        setDraftBody((prev) => prev + "\n<table><tr><td>í‘œ</td></tr></table>");
                      }
                      setToast({ open: true, severity: "info", message: "í‘œë¥¼ ì‚½ì…í–ˆì–´ìš”." });
                    }}
                  >
                    í‘œ ì‚½ì…
                  </Button>
                  <Button
                    variant="outlined"
                    size="small"
                    startIcon={<ImageIcon />}
                    sx={{ fontWeight: 900 }}
                    disabled={busy}
                    onClick={() => {
                      const input = document.createElement("input");
                      input.type = "file";
                      input.accept = "image/*";
                      input.multiple = true;
                      input.onchange = () => {
                        const files = Array.from(input.files || []);
                        if (files.length) onUploadMedia(files);
                      };
                      input.click();
                    }}
                  >
                    ì´ë¯¸ì§€ ì—…ë¡œë“œ
                  </Button>
                  
                  <Button
                    variant="outlined"
                    size="small"
                    startIcon={<VideoLibraryIcon />}
                    sx={{ fontWeight: 900 }}
                    disabled={busy}
                    onClick={() => {
                      const input = document.createElement("input");
                      input.type = "file";
                      input.accept = "video/*";
                      input.onchange = () => {
                        const files = Array.from(input.files || []);
                        if (files.length) onUploadMedia(files);
                      };
                      input.click();
                    }}
                  >
                    ì˜ìƒ ì—…ë¡œë“œ
                  </Button>
                  
                  <Button
                    variant="outlined"
                    size="small"
                    startIcon={<HorizontalRuleIcon />}
                    sx={{ fontWeight: 900 }}
                    onClick={insertDivider}
                  >
                    êµ¬ë¶„ì„ 
                  </Button>
                  
                  <Button
                    variant="outlined"
                    size="small"
                    startIcon={<ExpandMoreIcon />}
                    sx={{ fontWeight: 900 }}
                    onClick={insertToggle}
                  >
                    í† ê¸€
                  </Button>
                </Box>
              </Box>

              <Button
                variant="contained"
                size="large"
                sx={{ fontWeight: 900, py: 1.5, borderRadius: 2 }}
                disabled={busy}
                onClick={onSaveFaq}
              >
                {busy ? "ì €ì¥ ì¤‘..." : "FAQ ì €ì¥í•˜ê¸°"}
              </Button>
            </Box>
          )}
        </Box>
      </Box>

      {/* right: categories and links */}
      <Box sx={{ bgcolor: "background.paper", borderLeft: "1px solid", borderColor: "divider", overflow: "auto", p: 2 }}>
        <Box sx={{ display: "grid", gap: 3 }}>
          <Box>
            <Typography sx={{ fontWeight: 900, mb: 1.5 }}>ì£¼ë”” ê°€ì´ë“œ ë§í¬ (ì„ íƒ)</Typography>
            <Box sx={{ display: "grid", gap: 1.5 }}>
              {guideCats.map((c: any) => (
                  <Box key={c.id} sx={{ p: 2, border: "1px solid", borderColor: "divider", borderRadius: 2, bgcolor: "rgba(15,23,42,0.02)" }}>
                    <Box sx={{ display: "grid", gap: 1 }}>
                      <TextField
                        label="ê°€ì´ë“œ ì´ë¦„"
                        size="small"
                        fullWidth
                        value={c.name}
                        onChange={(e) => {
                          c.name = e.target.value;
                          setCategories([...(categories ?? [])]);
                        }}
                      />
                      <TextField
                        label="ìˆœì„œ(order)"
                        size="small"
                        type="number"
                        fullWidth
                        value={Number(c.order ?? 0)}
                        onChange={(e) => {
                          c.order = Number(e.target.value || 0);
                          setCategories([...(categories ?? [])]);
                        }}
                      />
                      <TextField
                        label="ì—°ê²° URL"
                        size="small"
                        fullWidth
                        value={c.guide_url ?? ""}
                        onChange={(e) => {
                          c.guide_url = e.target.value;
                          c.is_guide_link = true;
                          setCategories([...(categories ?? [])]);
                        }}
                      />
                      <Box sx={{ display: "flex", gap: 1, mt: 0.5 }}>
                        <Button variant="contained" size="small" sx={{ fontWeight: 900, flex: 1 }} disabled={busy} onClick={() => onSaveCategory(c)}>
                          ì €ì¥
                        </Button>
                        <Button variant="outlined" color="error" size="small" sx={{ fontWeight: 900 }} disabled={busy} onClick={() => onDeleteCategory(c)}>
                          ì‚­ì œ
                        </Button>
                      </Box>
                    </Box>
                  </Box>
                ))}

              {guideCats.length === 0 ? (
                <Typography variant="body2" sx={{ color: "text.secondary" }}>
                  ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ì…”ë„ ê´œì°®ì•„ìš”. ìœ ì € FAQì˜ â€œì£¼ë”” - ê°€ì´ë“œâ€ ì¹´ë“œëŠ” ë§í¬ê°€ ì—†ìœ¼ë©´ ë¹„í™œì„± ìƒíƒœë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                </Typography>
              ) : null}
            </Box>
          </Box>

          <Divider />

          <Box>
            <Typography sx={{ fontWeight: 900, mb: 1.5 }}>FAQ ëŒ€ë¶„ë¥˜ ì¹´í…Œê³ ë¦¬</Typography>
            <Box sx={{ display: "grid", gap: 1 }}>
              {mainCats.map((c: any) => (
                <Box
                  key={c.id}
                  sx={{
                    display: "grid",
                    gridTemplateColumns: "1fr 96px 40px 40px",
                    gap: 1,
                    alignItems: "center",
                    p: 1,
                    border: "1px solid",
                    borderColor: "divider",
                    borderRadius: 2,
                  }}
                >
                  <TextField
                    size="small"
                    fullWidth
                    value={c.name}
                    onChange={(e) => {
                      c.name = e.target.value;
                      setCategories([...(categories ?? [])]);
                    }}
                    InputProps={{ sx: { bgcolor: "#fff" } }}
                  />
                  <TextField
                    size="small"
                    type="number"
                    value={Number(c.order ?? 0)}
                    onChange={(e) => {
                      c.order = Number(e.target.value || 0);
                      setCategories([...(categories ?? [])]);
                    }}
                    InputProps={{ sx: { bgcolor: "#fff" } }}
                  />
                  <Button
                    variant="text"
                    size="small"
                    disabled={busy}
                    onClick={() => onSaveCategory(c)}
                    title="ì €ì¥"
                    sx={{ minWidth: 0, p: 0.75 }}
                  >
                    <SaveOutlinedIcon fontSize="small" />
                  </Button>
                  <Button
                    variant="text"
                    size="small"
                    disabled={busy}
                    onClick={() => onDeleteCategory(c)}
                    title="ì‚­ì œ"
                    sx={{ minWidth: 0, p: 0.75, color: "#DC2626" }}
                  >
                    <DeleteOutlineIcon fontSize="small" />
                  </Button>
                </Box>
              ))}

              <Box sx={{ p: 1.5, border: "1px dashed", borderColor: "divider", borderRadius: 2 }}>
                <Typography sx={{ fontWeight: 900, mb: 1, fontSize: "0.85rem" }}>ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</Typography>
                <Box sx={{ display: "grid", gap: 1 }}>
                  <TextField
                    size="small"
                    fullWidth
                    placeholder="ì´ë¦„"
                    value={newCatIsGuide ? "" : newCatName}
                    onChange={(e) => {
                      setNewCatIsGuide(false);
                      setNewCatName(e.target.value);
                    }}
                  />
                  <TextField
                    size="small"
                    type="number"
                    placeholder="order"
                    value={newCatIsGuide ? 0 : Number(newCatOrder ?? 0)}
                    onChange={(e) => {
                      setNewCatIsGuide(false);
                      setNewCatOrder(Number(e.target.value || 0));
                    }}
                  />
                  <Button variant="contained" size="small" sx={{ fontWeight: 900 }} disabled={busy} onClick={onCreateCategory}>
                    ì¶”ê°€
                  </Button>
                </Box>
              </Box>
            </Box>
          </Box>
        </Box>
      </Box>
    </Box>
    <Snackbar
      open={toast.open}
      autoHideDuration={2200}
      onClose={() => setToast((t) => ({ ...t, open: false }))}
      anchorOrigin={{ vertical: "bottom", horizontal: "center" }}
    >
      <Alert
        onClose={() => setToast((t) => ({ ...t, open: false }))}
        severity={toast.severity}
        variant="filled"
        sx={{ fontWeight: 900 }}
      >
        {toast.message}
      </Alert>
    </Snackbar>
    </>
  );
}


